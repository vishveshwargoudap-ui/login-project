<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
</head>
<body>
    <div class="cart-page">
        <header class="cart-header">
            <div>
                <p class="sub-title">Welcome, {{ user.name }}</p>
                <h1>Shopping Cart</h1>
            </div>
            <a class="back-link" href="{{ url_for('auth.dashboard') }}">Continue Shopping</a>
        </header>

        <section class="cart-panel">
            <table id="cart-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="cart-body"></tbody>
            </table>
            
            <div class="cart-summary">
                <h2 id="grand-total">Grand Total: Rs 0.00</h2>
            </div>
        </section>
    </div>

    <script>
        const CART_KEY = "cartItems";
        const imageBase = "{{ url_for('static', filename='images/') }}";
        const fallbackImage = "{{ url_for('static', filename='images/demo.jpg') }}";

        function getCartItems() {
            try {
                const items = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
                return Array.isArray(items) ? items : [];
            } catch (e) {
                return [];
            }
        }

        function saveCartItems(items) {
            localStorage.setItem(CART_KEY, JSON.stringify(items));
        }

        function updateQty(id, delta) {
            const items = getCartItems().map(item => {
                if (item.id === id) {
                    return { ...item, qty: Math.max(1, (Number(item.qty) || 1) + delta) };
                }
                return item;
            });
            saveCartItems(items);
            renderCart();
        }

        function removeItem(id) {
            const items = getCartItems().filter(item => item.id !== id);
            saveCartItems(items);
            renderCart();
        }

        function renderCart() {
            const cartBody = document.getElementById("cart-body");
            const grandTotalEl = document.getElementById("grand-total");
            const items = getCartItems();

            if (!items.length) {
                cartBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-cart">Your cart is empty right now.</td>
                    </tr>
                `;
                grandTotalEl.textContent = "Grand Total: Rs 0.00";
                return;
            }

            let grandTotal = 0;
            cartBody.innerHTML = items.map(item => {
                const qty = Number(item.qty) || 1;
                const price = Number(item.price) || 0;
                const total = qty * price;
                grandTotal += total;
                const img = item.image ? imageBase + item.image : fallbackImage;

                return `
                    <tr>
                        <td><img src="${img}" alt="${item.name || 'Product'}" onerror="this.onerror=null;this.src='${fallbackImage}'"></td>
                        <td class="product-name">${item.name || "Product"}</td>
                        <td>Rs ${price.toFixed(2)}</td>
                        <td>
                            <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                            <span class="qty-number">${qty}</span>
                            <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                        </td>
                        <td class="total">Rs ${total.toFixed(2)}</td>
                        <td><button class="remove-btn" onclick="removeItem(${item.id})">Remove</button></td>
                    </tr>
                `;
            }).join("");

            grandTotalEl.textContent = `Grand Total: Rs ${grandTotal.toFixed(2)}`;
        }

        renderCart();
    </script>
</body>
</html>
