<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payment.css') }}">
</head>
<body>
    <main class="payment-page">
        <header class="payment-header">
            <div>
                <p class="sub-title">Checkout for {{ user.name }}</p>
                <h1>Choose Payment Method</h1>
            </div>
            <a class="back-link" href="{{ url_for('auth.cart') }}">Back to Cart</a>
        </header>

        <section class="payment-grid">
            <form id="paymentForm" class="payment-card">
                <div class="method-details">
                    <label for="phone">Phone Number</label>
                    <input id="phone" type="text" placeholder="Enter phone number" value="{{ user.phone or '' }}">
                </div>

                <label class="method-card">
                    <input type="radio" name="method" value="upi" checked>
                    <div>
                        <h2>Manual UPI Payment</h2>
                        <p>Pay to UPI ID and submit transaction ID.</p>
                    </div>
                </label>

                <div id="manualUpiDetails" class="method-details hidden">
                    <p class="hint">UPI ID: <strong>puttarajbakery@upi</strong></p>
                    <label for="utr">UTR / Transaction ID</label>
                    <input id="utr" type="text" placeholder="Enter transaction ID after payment">
                </div>

                <label class="method-card">
                    <input type="radio" name="method" value="cash">
                    <div>
                        <h2>Pay When You Visit Store</h2>
                        <p>Confirm order now and pay cash at pickup.</p>
                    </div>
                </label>

               <button id="pay-btn" type="button" class="confirm-btn">pay now</button>
            </form>

            <aside class="summary-card">
                <h3>Order Summary</h3>
                <p id="itemCount">Items: 0</p>
                <p id="orderTotal">Total: Rs 0.00</p>
                <p class="note">After confirmation, your cart will be cleared.</p>
            </aside>
        </section>
    </main>

    <script>
        const cartItems = JSON.parse(localStorage.getItem("cartItems") || "[]");
        const itemCountEl = document.getElementById("itemCount");
        const totalEl = document.getElementById("orderTotal");
        const payBtn = document.getElementById("pay-btn");
        const phoneInput = document.getElementById("phone");
        const utrInput = document.getElementById("utr");
        const manualUpiDetails = document.getElementById("manualUpiDetails");

        const totalQty = cartItems.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
        const totalPrice = cartItems.reduce((sum, item) => sum + ((Number(item.qty) || 0) * (Number(item.price) || 0)), 0);

        itemCountEl.textContent = `Items: ${totalQty}`;
        totalEl.textContent = `Total: Rs ${totalPrice.toFixed(2)}`;

        function getSelectedMethod() {
            return document.querySelector('input[name="method"]:checked')?.value || "upi";
        }

        function updateMethodView() {
            const method = getSelectedMethod();
            if (method === "upi") {
                manualUpiDetails.classList.remove("hidden");
            } else {
                manualUpiDetails.classList.add("hidden");
            }
        }

        document.querySelectorAll('input[name="method"]').forEach((input) => {
            input.addEventListener("change", updateMethodView);
        });

        // Attach checkout flow only to the Pay button click.
        payBtn.addEventListener("click", async (event) => {
            // Prevent the form's default submit/navigation behavior.
            event.preventDefault();

            if (!phoneInput.value.trim()) {
                alert("Please enter phone number.");
                phoneInput.focus();
                return;
            }

            if (!cartItems.length) {
                alert("Your cart is empty. Please add products first.");
                window.location.href = "{{ url_for('auth.cart') }}";
                return;
            }

            const method = getSelectedMethod();

            if (method === "upi" && !utrInput.value.trim()) {
                alert("Please enter UTR / Transaction ID for manual UPI payment.");
                utrInput.focus();
                return;
            }

            try {
                const placeOrderResponse = await fetch("{{ url_for('auth.place_order') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        items: cartItems,
                        payment_mode: method,
                        transaction_id: method === "upi" ? utrInput.value.trim() : "",
                        phone: phoneInput.value.trim()
                    })
                });

                const placeOrderData = await placeOrderResponse.json();
                if (!placeOrderResponse.ok || !placeOrderData.ok || !placeOrderData.redirect_url) {
                    alert(placeOrderData.message || "Failed to place order.");
                    return;
                }

                localStorage.removeItem("cartItems");
                window.location.href = placeOrderData.redirect_url;
            } catch (error) {
                alert("Unable to place order right now. Please try again.");
            }
        });

        updateMethodView();
    </script>
</body>
</html>
